<template>
  <v-toolbar class="mt-5">
    <v-btn-toggle v-model="reportSource" mandatory>
      <v-btn> File </v-btn>
      <v-btn> URL </v-btn>
    </v-btn-toggle>

    <VueFileAgent
      ref="fileAgent"
      v-if="reportSource === 0"
      class="upload-block ma-2"
      :multiple="false"
      :deletable="true"
      :theme="'list'"
      @select="onFileChange"
      @beforedelete="onFileDeleted"
      helpText="Choose file"
      accept="application/json"
      :errorText="{
        size: 'This file is too large to be attached',
      }"
    >
    </VueFileAgent>

    <v-text-field
      v-if="reportSource === 1"
      v-model="url"
      label="Url"
      class="mx-2"
      hide-details
    ></v-text-field>
    <v-btn
      v-if="reportSource === 1"
      :loading="loading"
      :disabled="loading || !url"
      @click="fetchReportFromUrl"
      class="mx-2"
    >
      Fetch
    </v-btn>

    <v-autocomplete
      v-model="selectedTarget"
      clearable
      :items="vulnerabilityReport"
      item-text="Target"
      item-value="Target"
      label="Select Target"
      hide-details
    ></v-autocomplete>
  </v-toolbar>
</template>

<script lang="ts">
import Vue from "vue"
import VueFileAgent, { FileRecord } from "vue-file-agent"
import { Component, Ref, Watch } from "vue-property-decorator"
import {
  Version1OrVersion2,
  Vulnerability,
  VulnerabilityReportFile,
  VulnerabilityReportTarget,
} from "@/types"

Vue.use(VueFileAgent)

@Component
export default class DataInput extends Vue {
  private selectedTarget = ""
  private reportSource = 0
  private url = ""
  private loading = false
  @Ref() readonly fileAgent!: {
    deleteFileRecord: (fileRecordOrRaw: FileRecord) => void
  }

  get selectedVulnerabilities(): Vulnerability[] {
    if (this.selectedTarget) {
      return this.vulnerabilityReport.find(
        (i) => i.Target === this.selectedTarget
      )?.Vulnerabilities
    } else {
      return this.vulnerabilityReport
        .filter((vr) => vr.Vulnerabilities)
        .flatMap((vr) => vr.Vulnerabilities)
    }
  }

  file: FileRecord | Record<string, never> = {}
  private vulnerabilityReport: VulnerabilityReportTarget[] = [
    { Target: "test", Type: "type" },
  ]

  @Watch("selectedTarget")
  public onNewTarget(): void {
    this.$emit("inputChanged", this.selectedVulnerabilities)
  }

  private parseFile(
    fileEvent: ProgressEvent<FileReader>
  ): VulnerabilityReportTarget[] {
    let vulnerabilityTargets: VulnerabilityReportTarget[]
    if (
      fileEvent?.target?.result &&
      typeof fileEvent.target.result === "string"
    ) {
      const parsedReport = JSON.parse(fileEvent.target.result)
      vulnerabilityTargets = this.extractTargetsFromReport(parsedReport)
    }
    return vulnerabilityTargets
  }

  private isSchemaVersion2(
    obj: Version1OrVersion2
  ): obj is VulnerabilityReportFile {
    return !Array.isArray(obj) && obj.SchemaVersion >= 2
  }

  private extractTargetsFromReport(parsedReport: Version1OrVersion2) {
    let vulnerabilityTargets: VulnerabilityReportTarget[]
    if (this.isSchemaVersion2(parsedReport)) {
      vulnerabilityTargets = parsedReport.Results
    } else {
      vulnerabilityTargets = parsedReport
    }

    vulnerabilityTargets.forEach((vr) =>
      vr.Vulnerabilities?.forEach((v) => (v.Target = vr.Target))
    )
    return vulnerabilityTargets
  }

  public onFileDeleted(fileRecord: FileRecord): void {
    this.fileAgent.deleteFileRecord(fileRecord)
  }

  @Watch("file")
  public onFileChange(files: FileRecord[]): void {
    const selectedFile = files[0]
    const reader = new FileReader()
    reader.onload = (e) => {
      const vulnerabilityTargets = this.parseFile(e)
      if (vulnerabilityTargets) {
        this.handleNewReport(vulnerabilityTargets)
      }
    }
    reader.readAsText(selectedFile.file)
  }

  private handleNewReport(vulnerabilityTargets: VulnerabilityReportTarget[]) {
    this.vulnerabilityReport.splice(0)
    this.vulnerabilityReport.push(...vulnerabilityTargets)
    this.onNewTarget()
  }

  public async fetchReportFromUrl(): Promise<void> {
    if (this.url) {
      this.loading = true
      const response = await fetch(this.url)
      this.loading = false
      const contentType = response.headers.get("content-type")
      if (
        response.ok &&
        contentType &&
        contentType.indexOf("application/json") !== -1
      ) {
        const report = await response.json()
        const vulnerabilityTargets = this.extractTargetsFromReport(report)
        this.handleNewReport(vulnerabilityTargets)
      }
    }
  }
}
</script>

<style scoped>
@import "~vue-file-agent/dist/vue-file-agent.css";
</style>
